<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <style>
    .slider-container {
      margin-left: 20px;
      width: 50%;
    }

    .slider {
      margin-top: 20px;
      width: 100%;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      padding: 0;
      text-align: center;
      list-style: none;
      width: 102%;
    }

    .tooltip {
      /* position: absolute;
      display: inline-block; */
      display:block;
    position:fixed;
    overflow:hidden;
    }

    body {
      font-family: 'Avenir Next';
      background-color: white;
      margin: 0px;
      padding: 0px;
    }

    svg {
      background-color: rgb(255, 255, 255);
    }

    #Intro {
      padding: 15%;
      text-align: center;
    }

    h1 {
      font-size: 2em;
    }

    h2 {
      font-size: 1.0em;
    }

    p {
      font-size: 1.0em;
      font-size: 18px;
      text-align: center;
      padding-bottom: 30px;
    }

    .date {
      margin: 0;
      position: relative;
      text-align: left;
      color: white;
      font-weight: bold;
      padding: 0;
      padding-left: 1%;
      padding-top: 1%;
    }

    em {
      font-style: normal;
      font-weight: bolder;
      padding-bottom: 50px;
      margin-bottom: 20px;
    }

    #mapContainer {
      position: relative;
      max-width: 100%;
      background-color: rgb(23, 52, 77);
      padding-bottom: 5%;
      height: 600px;
    }

    svg.mapSVG {
      background-color: rgb(23, 52, 77);
    }

    #map {
      /* opacity: .8; */
      max-width: 50%;
      position: absolute;

    }

    #mapText {
      position: absolute;
      text-align: center;
      float: right;
      margin-top: 5%;
      margin-bottom: 5%;
      margin-left: 70%;
      margin-right: 10%;
      padding: 2%;
      background-color: rgba(255, 255, 255, 0.164);
      color: white;
    }

    #legend {
      position: absolute;
      text-align: left;
      float: right;
      margin-top: 300px;
      margin-left: 70%;
      margin-right: 5%;
      margin-bottom: 50px;
      padding: 2%;
      background-color: rgba(255, 255, 255, 0.164);
      color: white;
    }


    .key-dot {
      display: inline-block;
      height: 10px;
      margin-right: .5em;
      width: 20px;
    }

    .first { background: #EC6967; align:left;}
    .second{ background: #F4B1B2;}
    .third { background: #FFA764;}
    .forth { background: #FED19B;}
    .fifth { background: #78BD70;}
    .sixth { background: #C9E8AC;}
    .seventh { background: #69A2CB;}
    .eighth { background: #C0DCE8;}
    .ninth { background: #987284;}
    .tenth { background: #D8C8E0;}

    .happiness {
      margin: 0;
      text-align: left;
      border: 0;
      padding: 0;
    }

    .gridlines line {
      stroke: lightgrey;
      stroke-opacity: 0.7;
      stroke-width: 0.7;
      shape-rendering: crispEdges;
    }


    text {
      font-family: Avenir, Arial, Helvetica, sans-serif;
      font-size: 14px;
      stroke-opacity: 0.9;
      shape-rendering: crispEdges;
    }

    .label {
      font-style: italic;
      font-size: 16px;
    }

    .boundary {
      stroke: rgb(23, 52, 77);
      stroke-width: .4px;
    }

    .hidden {
      display: none;
    }

    #plotcontainer {
      display: flex;
      margin-top: 100px;
      max-width: 1300;
    }



    #plot1 {
      margin: 20px;
      flex-grow: 1;
    }

    #plot2 {
      margin: 20px;
      flex-grow: 1;
    }

    #plot2 p {
      margin-bottom: 45px;
    }

    #averageDonut {
      margin-top: 40px;
      padding: 5%;
      position: relative;
      float: left;

    }

    .donutGraphs {
      padding: 20%;
      padding-top: 0px;
      align-content: right;
      position: absolute;
      max-width: 100%;
      margin-left: 5%;
      margin-right: 5%;
      /* margin-left: 50px; */
    }

    #colorLegendPie {
      width: 200px;
      height: 300px;
      position: relative;
      float: right;
      margin-left: 100px;
      margin-top: 20px;
    }

    #colorBox {
      width: 20px;
      height: 20px;
      position: relative;
      float: left;
    }

    p#colorlabel {
      position: relative;
      float: right;
    }

    .overrideText {
      text-align: left;
      font-size: 1em;
      padding-left: 40px;
      padding-bottom: 0px;
    }

    #titleText {
      align-content: center;
      text-align: center;
      padding-top: 40px;
    }

    .flex-container {
      display: flex;
      max-width: 100%;
      padding-left: 100px;
      margin-bottom: 10%;
    }

    #Norway,
    #Jamaica,
    #Burundi {
      width: 33%;
      align-content: center;
      margin-top: 5%;
    }

    #plot3 p {
      padding-left: 5%;
      padding-right: 10%;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    #plot1 {
      margin: 20px;
      flex-grow: 1;
    }

    #plot2 {
      margin: 20px;
      flex-grow: 1;
    }

    #plot2 p {
      margin-bottom: 45px;
    }


  div.tooltip {
    position: absolute;
    text-align: center;
    padding: 4px;
    width: 120px;
    height: 30px;
    font: 12px sans-serif;
    background: #f6fbfc;
    border: 1px solid grey;
    border-radius: 3px;
    pointer-events: none;
  }

  </style>

</head>

<body>

  <div id='Intro'>
    <h1>Spotify</h1>
    <h2>Spotify</h2>
  </div>

  <div id="mapContainer">
    <div id="map"></div>
    <div id="mapText">
      <p class="date"></p>
    </div>
    <!-- create div for color legend -->
    <div id="legend">
      <div class="legend1">
        <p class="happiness"><span class="key-dot first"></span>Shape of You</p>
      </div>
      <div class="legend1">
        <p class="happiness"><span class="key-dot second"></span>Despacito</p>
      </div>
      <div class="legend1">
        <p class="happiness"><span class="key-dot third"></span>Starboy</p>
      </div>
      <div class="legend1">
        <p class="happiness"><span class="key-dot forth"></span>Rockstar</p>
      </div>
      <div class="legend1">
        <p class="happiness"><span class="key-dot fifth"></span>Mi Gente</p>
      </div>
      <div class="legend1">
        <p class="happiness"><span class="key-dot sixth"></span>Felices los 4</p>
      </div>
      <div class="legend1">
        <p class="happiness"><span class="key-dot seventh"></span>Look What You Made Me Do</p>
      </div>
      <div class="legend1"> <p class="happiness"><span class="key-dot eighth"></span>Criminal</p> </div>
    <div class="legend1"> <p class="happiness"><span class="key-dot ninth"></span>Something Just Like This</p> </div>
    <div class="legend1"> <p class="happiness"><span class="key-dot tenth"></span>Me Rehúso</p> </div>
    </div>

    <div id="map"></div>

  </div>

  <div class='slider-container'>
    <!-- <input type="range" min="0" max="47" value="0" class="slider" step='1'> -->
    <input type="range" min="0" max="364" value="0" class="slider" step='1'>
    <ul class='slider-labels'>
      <li>Jan</li>
      <li>Feb</li>
      <li>Mar</li>
      <li>Apr</li>
      <li>May</li>
      <li>Jun</li>
      <li>Jul</li>
      <li>Aug</li>
      <li>Sept</li>
      <li>Oct</li>
      <li>Nov</li>
      <li>Dec</li>
    </ul>
  </div>

  <!-- END HTML START JS -->

  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="https://d3js.org/d3-axis.v1.min.js"></script>
  <script>
    var width = 962,
      rotated = 90,
      height = 600;

    var projection = d3.geoMercator()
      .scale(125)
      .translate([width / 2.5, height / 1.4]);


    var svg = d3.select("#map").append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("class", "mapSVG");

    var path = d3.geoPath()
      .projection(projection);

    var g = svg.append("g");

    //Spotify DATA READ IN
    d3.csv("./Book500.csv").then(function (tempData) {
      const addMoreData = () => {
          if (tempData[0].region2 !== undefined) return
          const data = []
          let lastDate = null
          let index = -1

          tempData.forEach(song => {
            const { region, trackName, date } = song
            let region2, color

            if (trackName === 'Shape of You') color = '#EC6967'
            else if (trackName === 'Despacito - Remix') color ='#F4B1B2'
            else if (trackName === 'Starboy') color = '#FFA764'
            else if (trackName === 'Rockstar') color = '#FED19B'
            else if (trackName === 'Mi Gente') color = '#78BD70'
            else if (trackName === 'Felices los 4') color = '#C9E8AC'
            else if (trackName === 'Look What You Made Me Do') color = '#69A2CB'
            else if (trackName === 'Criminal') color = '#C0DCE8'
            else if (trackName === 'Something Just Like This') color = '#987284'
            else if (trackName === 'Me RehÃºso') color = '#D8C8E0'

            if (region === 'ar') region2 = 'ARG'
            else if (region === 'at') region2 = 'AUT'
            else if (region === 'au') region2 = 'AUS'
            else if (region === 'be') region2 = 'BEL'
            else if (region === 'bo') region2 = 'BOL'
            else if (region === 'br') region2 = 'BRA'
            else if (region === 'ca') region2 = 'CAN'
            else if (region === 'ch') region2 = 'CHE'
            else if (region === 'cl') region2 = 'CHL'
            else if (region === 'co') region2 = 'COL'
            else if (region === 'cr') region2 = 'CRI'
            else if (region === 'cz') region2 = 'CZE'
            else if (region === 'cz') region2 = 'CZE'
            else if (region === 'de') region2 = 'DEU'
            else if (region === 'dk') region2 = 'DNK'
            else if (region === 'do') region2 = 'DMA'
            else if (region === 'ec') region2 = 'ECU'
            else if (region === 'ee') region2 = 'ETH'
            else if (region === 'es') region2 = 'ESP'
            else if (region === 'fi') region2 = 'FIN'
            else if (region === 'fr') region2 = 'FRA'
            else if (region === 'gb') region2 = 'GBR'
            else if (region === 'gr') region2 = 'GRC'
            else if (region === 'gt') region2 = 'GTM'
            else if (region === 'hk') region2 = 'HKG'
            else if (region === 'hn') region2 = 'HND'
            else if (region === 'hu') region2 = 'HUN'
            else if (region === 'id') region2 = 'IDN'
            else if (region === 'ie') region2 = 'IRL'
            else if (region === 'is') region2 = 'ISL'
            else if (region === 'it') region2 = 'ITA'
            else if (region === 'jp') region2 = 'JPN'
            else if (region === 'lt') region2 = 'LTU'
            else if (region === 'lu') region2 = 'LUX'
            else if (region === 'lv') region2 = 'LVA'
            else if (region === 'mx') region2 = 'MEX'
            else if (region === 'my') region2 = 'MYS'
            else if (region === 'nl') region2 = 'NLD'
            else if (region === 'no') region2 = 'NOR'
            else if (region === 'nz') region2 = 'NZL'
            else if (region === 'pa') region2 = 'PAN'
            else if (region === 'pe') region2 = 'PER'
            else if (region === 'ph') region2 = 'PHL'
            else if (region === 'pl') region2 = 'POL'
            else if (region === 'pt') region2 = 'PR1'
            else if (region === 'py') region2 = 'PRY'
            else if (region === 'se') region2 = 'SWE'
            else if (region === 'sk') region2 = 'SVK'
            else if (region === 'sv') region2 = 'SLV'
            else if (region === 'tr') region2 = 'TUR'
            else if (region === 'tw') region2 = 'TWN'
            else if (region === 'us') region2 = 'USA'
            else if (region === 'uy') region2 = 'URY'

            const songObj = {
              ...song,
                region2,
                color
            }
            if (date === lastDate) {
              const arrOfDate = data[index]
              arrOfDate.push(songObj)
            } else {
                data.push([songObj])
              index++
            }

            lastDate = date
          });

          return data
        }
      const spotifyData = addMoreData()

      // PROMISE FOR COUNTREIS AND FILL
      d3.json("combined2.json").then(function (world) {
        const changeCountryColor = (sliderValue) => {
          svg.selectAll('path')
          .on("mousemove", mouseOnPlot)
          .on("mouseout", mouseLeavesPlot)
          .style("fill", function (d) {
            const countryID = d.id
            let colorReturn = d3.rgb('#000');

            const listSongsOnDate = spotifyData[sliderValue]

            listSongsOnDate.forEach(song => {
              if (song.region2 === countryID) {
                colorReturn = song.color
              }
            })

            return colorReturn
          })
          .attr("d", path);
        }

        svg.selectAll('path')
          .data(topojson.feature(world, world.objects.countries).features)
          .enter().append("path")
          .attr("name", function (d) { return d.properties.name; })
          .attr("id", function (d) { return d.id; })

        d3.select('.slider').on('input', function () {
          changeCountryColor(this.value)
          d3.selectAll('.date')
            .text(spotifyData[this.value][0]['date'])
        })

        changeCountryColor(1)
        d3.selectAll('.date')
            .text(spotifyData[0][0]['date'])
      });
    });

    var tooltip = d3.select("#mapContainer")
                      .append("div")
                      .attr("id", "tooltip")
                      .attr("class", "tooltip")
                      .style("opacity", 0);
    var tooltipWidth = parseFloat(tooltip.style("width"));
    var tooltipHeight = parseFloat(tooltip.style("height"));

    // d3.selectAll(".country").on("mousemove", mouseOnPlot);
    // d3.selectAll(".country").on("mouseout", mouseLeavesPlot);

    function mouseOnPlot() {
      // Move the tooltip
      //console.log(event);
      console.log(event.pageX);
      const x = (event.clientX) + 'px'
      const y = (event.clientY) + 'px'
      tooltip.style("left", x);
      tooltip.style("top", y);

      // Clear whatever is there
      tooltip.html("");

      // Give the tooltip a country label
      let country = d3.select(this);
      //tooltip.append("div").text(idToCountry[country.attr("ident")]);

      // Show the tooltip!
      tooltip.style("opacity",1);
    }
    function mouseLeavesPlot() {
      tooltip.style("opacity",0);
    }

  </script>
</body>

</html>
